const AWS = require('aws-sdk');

const generateToken = require('../controllers/generateToken');

const multer = require('multer');

const multerS3 = require('multer-s3');

const accessKeyId = 'AKIAJWT44GNU44LLH7JA';

const secretAccessKey = '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';

AWS.config.update({

    accessKeyId: accessKeyId,
    secretAccessKey: secretAccessKey,
    region: "ca-central-1"

});

const fs = require('fs');

const s3 = new AWS.S3();

let upload = multer({

    storage: multerS3({

        s3: s3,

        bucket: "jammr-app-bucket",

        key: function (req, file, cb) {
            console.log(file);
            cb(null, Date.now().toString()); //use Date.now() for unique file keys
        }
    })

});


const User = require('../models/user');

router.put('/', authentication.verifyOrdinaryUser, upload.single('file'), (req, res) => {

    User.findOneAndUpdate({username: req.decoded.username, creationDate: req.decoded.creationDate},

    { $set: {

      profilePic: String(req.file.location)

    }},

    {new: true}

    ).then(user => {

        res.json(user)

    })

});

module.exports = router;


///////// THe below don't work




const bcrypt = require('bcryptjs');
const authentication = require('../controllers/authentication');
const express = require('express');
const passport = require('passport');
const passportService = require('../services/passport');


const config = require('../config/config.js');

const axios = require('axios');

const router = express.Router();
const mongodb = require('mongodb');
const mongoose = require('mongoose');
const jwt = require('jsonwebtoken');
mongoose.Promise = Promise;

const fs = require('fs');

const AWS = require('aws-sdk');

const generateToken = require('../controllers/generateToken');

const multer = require('multer');

const multerS3 = require('multer-s3');

const accessKeyId = 'AKIAJWT44GNU44LLH7JA';

const secretAccessKey = '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';

AWS.config.update({

    accessKeyId: accessKeyId,
    secretAccessKey: secretAccessKey,
    region: "ca-central-1"

});



const myBucket = new AWS.S3({params: {Bucket: 'jammr-app-bucket'}});

function uploadToS3(file, destFileName, callback) {

    myBucket

        .upload({

            ACL: 'public-read',

            Body: fs.createReadStream(file.path),

            Key: destFileName.toString(),

            ContentType: 'application/octet-stream'

        })

        .send(callback);


}


const User = require('../models/user');

router.put('/', authentication.verifyOrdinaryUser, multer({limits: {fileSize:10*1024*1024}}), (req, res) => {

    if (!req.files || !req.files.imageSentFromClient){

        return res.status(403).send("Image uploading don't work").end();

    }

    //// this is the image sent from the client In react client , the variable of the image being sent must be
    /// called imageSentFromClient

    let imageSentFromClient = req.files.imageSentFromClient;

    if (!/^image\/(jpe?g|png|gif)$/i.test(imageSentFromClient.mimetype)) {
        return res.status(403).send('expect image file').end();
    }

    let pid = '10000' + parseInt(Math.random() * 10000000);



    uploadToS3(imageSentFromClient, pid, function(err, data){

        User.findOneAndUpdate({username: req.decoded.username, creationDate: req.decoded.creationDate},

            { $set: {

                profilePic: String(data.Location)

            }},

            {new: true}

        ).then(user => {

            res.json(user);

        })


    })





});

module.exports = router;



//// SHit don't work




const myBucket = new AWS.S3({params: {Bucket: 'jammr-app-bucket'}});

function uploadToS3(file, destFileName, callback) {

    myBucket

        .upload({

            ACL: 'public-read',

            Body: fs.createReadStream(file.path),

            Key: destFileName.toString(),

            ContentType: 'application/octet-stream'

        })

        .send(callback);


}


const User = require('../models/user');

router.put('/', authentication.verifyOrdinaryUser, multer({limits: {fileSize:10*1024*1024}}), (req, res) => {

    if (!req.file){

        return res.status(403).send("Image uploading don't work").end();

    }

    //// this is the image sent from the client In react client , the variable of the image being sent must be
    /// called imageSentFromClient

    let imageSentFromClient = req.file;

    if (!/^image\/(jpe?g|png|gif)$/i.test(imageSentFromClient.mimetype)) {
        return res.status(403).send('expect image file').end();
    }

    let pid = '10000' + parseInt(Math.random() * 10000000);



    uploadToS3(req.file, pid, function(err, data){

        User.findOneAndUpdate({username: req.decoded.username, creationDate: req.decoded.creationDate},

            { $set: {

                profilePic: String(data.Location)

            }},

            {new: true}

        ).then(user => {

            res.json(user);

        })


    })





});

module.exports = router;